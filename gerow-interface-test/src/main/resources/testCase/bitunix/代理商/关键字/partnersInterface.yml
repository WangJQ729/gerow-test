keyWord:
  step:
    - name: 登录partners
      host: ${partners_host}
      url: /partner/login
      method: POST
      body: |
        {"password":"${__digest(MD5,${password})}","account":"${partner_email}"}
      extractor:
        - json:
            partner_token: $.result.token
          site: TESTSUITE
    - name: 登录partners-新合伙人
      keyWord: 登录partners
      body: |
        {"password":"${__digest(MD5,${password})}","account":"${email}"}
    - name: 获取合伙人信息
      host: ${partners_host}
      url: /partner/getUserInfo
      headers:
        Token: ${partner_token}
      method: GET
      extractor:
        - json:
            partner_uid: $.result.uid
            partner_name: $.result.username
          site: TESTSUITE
    - name: 获取合伙人邀请码
      host: ${partners_host}
      url: /partner/statistics/myInvitation
      headers:
        Token: ${partner_token}
      method: GET
      extractor:
        - json:
            vipCode: $.result.vipCode
            exchangeSubRatio: $.result.exchangeSubRatio
            exchangeSelfRatio: $.result.exchangeSelfRatio
            futureSelfRatio: $.result.futureSelfRatio
            futureSubRatio: $.result.futureSubRatio
    - name: 升级为合伙人
      host: ${partners_host}
      url: /partner/add
      headers:
        Token: ${partner_token}
      method: POST
      body: |
        {"uid":${userId},"nickName":"${email}","futureRatio":${futureRatio},"exchangeRatio":${exchangeRatio}}
      assertion:
        - json:
            $.code: '0'
    - name: 升级为合伙人-最高返佣
      keyWord: 升级为合伙人
      body: |
        {"uid":${userId},"nickName":"${email}","futureRatio":${totalFutureRatio},"exchangeRatio":${totalExchangeRatio}}
    - name: 新用户升级为合伙人
      keyWord: 升级为合伙人
      bodyEditor:
        json:
          $.futureRatio: ${futureRatio}
          $.exchangeRatio: ${exchangeRatio}
          $.nickName: ${email}
    - name: 新用户升级为合伙人-修改返佣比例
      keyWord: 升级为合伙人
      body: |
        {"uid":${userId},"nickName":"${email}","futureRatio":${__groovy(${futureSelfRatio} - 10)},"exchangeRatio":${__groovy(${exchangeSelfRatio} - 10)}}
    - name: 直客佣金查询
      host: ${partners_host}
      url: /partner/rebate/userRebate/list
      headers:
        Token: ${partner_token}
      untilWait: 5
      variables:
        page: 1
        pageSize: 10
        uid: ${userId}
        showBelow: false
        tradeType: futures
      method: GET
      extractor:
        - json:
            makerFee: $.result.items[0].makerFee
            makerRebate: $.result.items[0].makerRebate
            makerTradeAmount: $.result.items[0].makerTradeAmount
          ignore: true
    - name: 直客佣金查询-首单
      keyWord: 直客佣金查询
      assertion:
        - json:
            $.result.items[0].makerFee: ${openDealFee}
            $.result.items[0].makerRebate: ${__groovy(${openDealFee} * (${totalExchangeRatio} - ${futureRatio}) / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 合伙人佣金查询-首单
      keyWord: 直客佣金查询
      assertion:
        - json:
            $.result.items[0].makerFee: ${openDealFee}
            $.result.items[0].makerRebate: ${__groovy(${openDealFee} * ${futureRatio} / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 合伙人佣金查询-平仓
      keyWord: 直客佣金查询
      assertion:
        - json:
            $.result.items[0].makerFee: ${__groovy(${makerFee} + ${closeDealFee})}
            $.result.items[0].makerRebate: ${__groovy(${makerRebate} + ${closeDealFee} * ${futureRatio}/ 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 直客佣金查询-开仓
      keyWord: 直客佣金查询
      assertion:
        - json:
            $.result.items[0].makerFee: ${__groovy(${makerFee} + ${openDealFee})}
            $.result.items[0].makerRebate: ${__groovy(${makerRebate} + ${openDealFee} *  (${totalExchangeRatio} - ${futureRatio}) / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 直客佣金查询-平仓
      keyWord: 直客佣金查询
      assertion:
        - json:
            $.result.items[0].makerFee: ${__groovy(${makerFee} + ${closeDealFee})}
            $.result.items[0].makerRebate: ${__groovy(${makerRebate} + ${closeDealFee} * (${totalExchangeRatio} - ${futureRatio})/ 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 直客佣金查询-获取现货交易数据
      keyWord: 直客佣金查询
      variables:
        coin: ${spotSymbols}
        tradeType: exchange
      extractor:
        - json:
            takerTradeAmount: $.result.items[0].takerTradeAmount
            takerFee: $.result.items[0].takerFee
            takerRealFee: $.result.items[0].takerRealFee
            takerRebate: $.result.items[0].takerRebate
          ignore: true
    - name: 直客佣金查询-校验现货交易数据
      keyWord: 直客佣金查询-获取现货交易数据
      assertion:
        - json:
            $.result.items[0].takerRebate: ${__groovy(${takerRebate} + ${webFee} * (${totalExchangeRatio} - ${exchangeRatio}) / 100)}
            $.result.items[0].takerFee: ${__groovy(${takerFee} + ${webFee})}
            $.result.items[0].takerRealFee: ${__groovy(${takerRealFee} + ${webFee})}
            $.result.items[0].takerTradeAmount: ${__groovy(${takerTradeAmount} + ${dealAmount})}
          assertionType: EIGHTDECIMALPLACES
          valueType: BIGDECIMAL
    - name: 代理商现货历史委托
      host: ${partners_host}
      url: /partner/trade/order/spot_history/history
      headers:
        Token: ${partner_token}
      variables:
        page: 1
        pageSize: 10
        uid: ${userId}
        showBelow: true
      method: GET
      extractor:
        - json:
            partnerFee: $.result.fee
    - name: 分后台获取用户信息
      host: ${partners_host}
      url: /partner/user/page
      headers:
        Token: ${partner_token}
      method: POST
      body: |
        {"page":1,"pageSize":10,"subShow":true,"uid":"${userId}","registerStart":"","registerEnd":""}
      extractor:
        - json:
            exchangeRatio: $.result.items[0].exchangeRatio
            futureRatio: $.result.items[0].futureRatio
            parentUid: $.result.items[0].parentUid
    - name: 代理商更新合伙人返佣比例
      host: ${partners_host}
      url: /partner/rebate/updatePartnerRatio
      headers:
        Token: ${partner_token}
      method: GET
      assertion:
        - json:
            $.code: '0'
    - name: 代理商后台差价佣金统计
      host: ${partners_host}
      url: /partner/rebate/partnerSubStatistic
      headers:
        Token: ${partner_token}
      method: GET
      assertion:
        - json:
            $.code: '0'
    - name: 代理商后台返佣发放
      sleep: 500
      host: ${partners_host}
      url: /partner/rebate/distribute
      variables:
        startTime: ${__groovy(${__time()} - 2 * 60 * 60 * 1000)}
        endTime: ${__time()}
      headers:
        Token: ${partner_token}
      method: GET
      assertion:
        - json:
            $.code: '0'
    - name: 代理商后台更新返佣统计
      sleep: 2000
      untilWait: 30
      host: ${partners_host}
      url: /partner/rebate/createRecord
      method: GET
      assertion:
        - json:
            $.code: '0'
    - name: 佣金发放明细
      host: ${partners_host}
      url: /partner/rebate/detail/list
      headers:
        Token: ${partner_token}
      method: GET
      variables:
        showBelow: true
        page: 1
        pageSize: 10
        minSentTime: ${__timeShift(yyyy-MM-dd,,P-1D,zh_CN,)}T16:00:00.000Z
        maxSentTime: ${__timeShift(yyyy-MM-dd,,,zh_CN,)}T16:00:00.000Z
    - name: 合约当前持仓
      host: ${partners_host}
      url: /partner/trade/position/pending
      headers:
        Token: ${partner_token}
      method: GET
      variables:
        showBelow: true
        page: 1
        pageSize: 10
    - name: 获取合伙人非默认邀请码
      host: ${partners_host}
      url: /partner/invite/page
      headers:
        Token: ${partner_token}
      method: POST
      body: |
        {"page":1,"pageSize":10}
      assertion: [json: {$.code: '0'}]
      extractor:
        - json:
            not_default_vipCode: $.result.items[?(@.isDefault == false)].vipCode
    - name: 创建推广页
      host: ${partners_host}
      url: /partner/promotional/create
      headers:
        Token: ${partner_token}
        Accept-Language: ${Accept-Language}
      method: POST
      body: |
        {
          "inviteCode": "${vipCode}",
          "url": "${url}",
          "shortLink": "${shortLink}"
        }
      assertion: [json: {$.code: '0'}]
    - name: 分后台佣金发放查询
      untilWait: 30
      host: ${partners_host}
      url: /partner/rebate/statistics/list
      headers:
        Token: ${partner_token}
      method: GET
      variables:
        showBelow: true
        page: 1
        pageSize: 10
        tradeType: futures
        symbol: ${symbol}
        minSentTime: ${__timeShift(yyyy-MM-dd,,P-1D,zh_CN,)}T16:00:00.000Z
        maxSentTime: ${__timeShift(yyyy-MM-dd,,,zh_CN,)}T16:00:00.000Z
      assertion: [json: {$.code: '0'}]
      extractor:
        - json:
            tradeAmount: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].tradeAmount
            realFee: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].realFee
            fee: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].fee
            userRebate: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].userRebate
            partnerRebate: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].partnerRebate
            subPartnerRebate: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].subPartnerRebate
          ignore: true
    - name: 分后台佣金发放查询-直客开仓
      keyWord: 分后台佣金发放查询
      assertion:
        - json:
            $.result.items[0].userRebate: ${__groovy(${userRebate} + ${openDealFee} * ${totalFutureRatio} / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 分后台佣金发放查询-直客平仓
      keyWord: 总后台佣金发放查询
      assertion:
        - json:
            $.result.items[0].userRebate: ${__groovy(${userRebate} + ${closeDealFee} * ${totalFutureRatio} / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 分后台佣金发放查询-合伙人开仓
      keyWord: 分后台佣金发放查询
      assertion:
        - json:
            $.result.items[0].subPartnerRebate: ${__groovy(${subPartnerRebate} + ${openDealFee} * (${totalFutureRatio} - ${futureRatio}) / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 分后台佣金发放查询-合伙人平仓
      keyWord: 分后台佣金发放查询
      assertion:
        - json:
            $.result.items[0].subPartnerRebate: ${__groovy(${subPartnerRebate} + ${closeDealFee} * (${totalFutureRatio} - ${futureRatio}) / 100)}
          assertionType: EIGHTDECIMALPLACES