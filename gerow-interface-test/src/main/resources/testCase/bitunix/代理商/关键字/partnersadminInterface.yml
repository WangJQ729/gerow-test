keyWord:
  step:
    - name: 登录partnersadmin
      host: ${partnersadmin_host}
      url: /partner/root/login
      method: POST
      body: |
        {"password":"${__digest(MD5,${partnersadmin_password})}","account":"${partnersadmin_account}"}
      extractor:
        - json:
            partnersadmin_token: $.result.token
          site: TESTSUITE
    - name: 获取BD列表
      host: ${partnersadmin_host}
      url: /partner/root/bdList
      headers:
        Token: ${partnersadmin_token}
      method: GET
      extractor:
        - json:
            bd_uid: $.result[?(@.nickName=='${bd_name}')].uid
    - name: 获取用户信息
      host: ${partnersadmin_host}
      url: /partner/root/getUserInfoByUid/${userId}
      headers:
        Token: ${partnersadmin_token}
      method: GET
      extractor:
        - json:
            nickName: $.result.nickname
    - keyWord: 获取用户信息
      name: 获取用户信息和上级代理uid
      extractor:
        - json:
            nickName: $.result.nickname
            superiorPartnerUid: $.result.parentUid
    - name: 新增合伙人
      host: ${partnersadmin_host}
      url: /partner/root/add
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        {"uid":${userId},"futureRatio":95,"exchangeRatio":95,"nickName":"${email}","bdUid":${bd_uid}}
    - name: 总后台佣金发放查询
      host: ${partnersadmin_host}
      url: /partner/root/rebate/statistics/list
      method: GET
      headers:
        Token: ${partnersadmin_token}
      variables:
        showBelow: true
        symbol: ${symbol}
        tradeType: futures
        partnerInfo: ${partner_uid}
        page: 1
        pageSize: 10
        minSentTime: ${__timeShift(yyyy-MM-dd,,P-1D,zh_CN,)}T16:00:00.000Z
        maxSentTime: ${__timeShift(yyyy-MM-dd,,,zh_CN,)}T16:00:00.000Z
      extractor:
        - json:
            tradeAmount: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].tradeAmount
            realFee: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].realFee
            fee: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].fee
            userRebate: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].userRebate
            partnerRebate: $.result.items[?(@.symbol=='${symbol}' && @.tradeType=='futures')].partnerRebate
    - name: 总后台佣金发放查询-开仓
      keyWord: 总后台佣金发放查询
      assertion:
        - json:
            $.result.items[0].userRebate: ${__groovy(${userRebate} + ${openDealFee} * ${totalFutureRatio} / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 总后台佣金发放查询-平仓
      keyWord: 总后台佣金发放查询
      assertion:
        - json:
            $.result.items[0].userRebate: ${__groovy(${userRebate} + ${closeDealFee} * ${totalFutureRatio} / 100)}
          assertionType: EIGHTDECIMALPLACES
    - name: 合伙人列表
      host: ${partnersadmin_host}
      url: /partner/root/page
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        {"page":1,"pageSize":10,"uid":"${partner_uid}","registerStart":"","registerEnd":"","pageIndex":1}
      extractor:
        - json:
            totalExchangeRatio: $.result.items[0].exchangeRatio
            totalFutureRatio: $.result.items[0].futureRatio
          site: TESTSUITE
    - name: 变更BD
      host: ${partnersadmin_host}
      url: /partner/root/change_bd
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        {"bdUid":1,"uid":${partner_uid}}
      assertion: [ json: { $.code: '0' } ]
    - name: BD统计
      untilWait: 5
      host: ${partnersadmin_host}
      url: /partner/root/get_bd_team_information
      method: GET
      headers:
        Token: ${partnersadmin_token}
      variables:
        page: 1
        pageSize: 10
        partnerInfo: ${bd_name}
        startTime: ${__PlusDay(yyyy-MM-dd,0,)}T00:00:00.000Z
        endTime: ${__PlusDay(yyyy-MM-dd,0,)}T23:59:59.999Z
        orderType: 4
        orderDirection: DESC
      extractor:
        - json:
            bdTotalPartners: $.result.items[0].totalPartners
            bdTeamSize: $.result.items[0].teamSize
            #新增用户
            bdNewUser: $.result.items[0].newUser
            #总交易额
            bdTradeAmount: $.result.items[0].totalTradeAmount
            #交易人数
            bdTotalTradeUsers: $.result.items[0].totalTradeUsers
            # 平台收益
            bdPlatformRevenue: $.result.items[0].platformRevenue
            # 佣金总计
            bdTotalCommission: $.result.items[0].totalCommission
            # 总手续费
            bdTotalFee: $.result.items[0].totalFee
    - keyWord: BD统计
      name: BD统计-校验新增合伙人
      assertion:
        - json:
            $.result.items[0].teamSize: ${__groovy(${bdTeamSize} + 1)}
            $.result.items[0].totalPartners: ${__groovy(${bdTotalPartners} + 1)}
            $.result.items[0].totalTradeAmount: ${bdTradeAmount}
            $.result.items[0].newUser: ${__groovy(${bdNewUser} + 1)}
    - keyWord: BD统计
      name: BD统计-用户合伙人邀请码注册
      assertion:
        - json:
            $.result.items[0].newUser: ${__groovy(${bdNewUser} + 1)}
            $.result.items[0].teamSize: ${__groovy(${bdTeamSize} + 1)}
            $.result.items[0].totalTradeAmount: ${bdTradeAmount}
            $.result.items[0].totalTradeUsers: ${bdTotalTradeUsers}
            $.result.items[0].platformRevenue: ${bdPlatformRevenue}
            $.result.items[0].totalCommission: ${bdTotalCommission}
            $.result.items[0].totalFee: ${bdTotalFee}
            $.result.items[0].totalPartners: ${bdTotalPartners}
    - name: BD统计-团队人数不变
      keyWord: BD统计
      assertion:
        - json:
            $.result.items[0].teamSize: ${bdTeamSize}
            $.result.items[0].totalPartners: ${bdTotalPartners}
            $.result.items[0].totalTradeAmount: ${bdTradeAmount}
            $.result.items[0].newUser: ${bdNewUser}
            $.result.items[0].platformRevenue: ${bdPlatformRevenue}
            $.result.items[0].totalCommission: ${bdTotalCommission}
            $.result.items[0].totalFee: ${bdTotalFee}
    - name: BD统计-开仓
      keyWord: BD统计
      assertion:
        - json:
            $.result.items[0].totalTradeAmount: ${__groovy(${bdTradeAmount} +${makerTradeAmount})}
            $.result.items[0].totalTradeUsers: ${__groovy(${bdTotalTradeUsers} + 1)}
            $.result.items[0].totalFee: ${__groovy(${bdTotalFee} + ${openDealFee})}
            $.result.items[0].platformRevenue: ${__groovy(${bdPlatformRevenue} + ${openDealFee} * (100 - ${bdExchangeRatio}) / 100)}
            $.result.items[0].totalCommission: ${__groovy(${bdTotalCommission} + ${openDealFee} * ${bdExchangeRatio} / 100)}
            $.result.items[0].totalPartners: ${bdTotalPartners}
          assertionType: EIGHTDECIMALPLACES
    - name: BD统计-平仓
      keyWord: BD统计
      assertion:
        - json:
            $.result.items[0].totalTradeAmount: ${__groovy(${bdTradeAmount} +${closeQuoteAmount})}
            $.result.items[0].totalTradeUsers: ${__groovy(${bdTotalTradeUsers})}
            $.result.items[0].totalFee: ${__groovy(${bdTotalFee} + ${closeDealFee})}
            $.result.items[0].platformRevenue: ${__groovy(${bdPlatformRevenue} + ${closeDealFee} * (100 - ${bdExchangeRatio}) / 100)}
            $.result.items[0].totalCommission: ${__groovy(${bdTotalCommission} + ${closeDealFee} * ${bdExchangeRatio} / 100)}
            $.result.items[0].totalPartners: ${bdTotalPartners}
          assertionType: EIGHTDECIMALPLACES
    - name: 新建社区活动
      host: ${partnersadmin_host}
      url: /partner/root/activity/create
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        { "uid": ${partner_uid},
          "titleList": [{"languageKey": "en-US","content": "${shortLink}"}],
          "enrollStartTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-8H,zh_CN,)}",
          "enrollEndTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-H-55M,zh_CN,)}",
          "startTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-H-55M,zh_CN,)}",
          "endTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-H-30M,zh_CN,)}",
          "actType": [
            {"rankType":1,"tradingVolume":0,"listDisplayVolume":5},
            {"rankType":2,"tradingVolume":0,"listDisplayVolume":8}
          ],
          "actDetail": [
            {"languageKey": "zh-CN","content": "<ul>\n<li>\n<p><strong>报名要求</strong>：</p>\n<ul>\n<li>所有社区注册用户均可报名。</li>\n<li>每位参赛者需提供真实有效的交易账号。</li>\n</ul>\n</li>\n<li>\n<p><strong>比赛内容</strong>：</p>\n<ul>\n<li>参赛者需要在指定平台进行交易，交易范围包括但不限于股票、期货、外汇等。</li>\n<li>比赛期间，参赛者需保持交易账户的公开透明，以便活动方实时监控和统计。</li>\n</ul>\n</li>\n<li>\n<p><strong>评分标准</strong>：</p>\n<ul>\n<li><strong>收益率</strong>：比赛期间，参赛者的总收益率将作为主要评判标准。</li>\n<li><strong>交易策略</strong>：参赛者需提交一份详细的交易策略报告，专家评审团将对其进行评分。</li>\n<li><strong>风险控制</strong>：评审团还将根据参赛者的交易风险控制措施进行评分。</li>\n</ul>\n</li>\n</ul>"},
            {"languageKey": "en-US","content": "<p>Registration requirements:</p>\n<p>All community registered users can register.<br />Each contestant must provide a real and valid trading account.<br />Content of the competition:</p>\n<p>Contestants need to trade on the designated platform, including but not limited to stocks, futures, foreign exchange, etc.<br />During the competition, contestants must keep their trading accounts open and transparent so that the event organizer can monitor and count them in real time.<br />Scoring criteria:</p>\n<p>Rate of return: During the competition, the total rate of return of the contestant will be the main judging criterion.<br />Trading strategy: Contestants need to submit a detailed trading strategy report, which will be scored by the expert jury.<br />Risk control: The jury will also score based on the contestant's trading risk control measures.</p>"}
          ],
          "futureMinBalance": 888,
          "minJoinUser": 0,
          "shortLink": "${shortLink}",
          "showEntrance": true,
          "entranceDisplay": [
            {"languageKey": "zh-CN","content": "展示你的交易天赋，赢取丰厚奖励！无论你是交易新手还是资深高手，只要你对交易充满热情，这就是你的舞台！"},
            {"languageKey": "en-US","content": "Show off your trading talents and win generous rewards!  Whether you are a novice trader or a seasoned expert, as long as you are passionate about trading, this is your stage!"}
          ],
          "activityEndDisplayInformation": [{"languageKey": "en-US","content": "test"}],
          "vipCode": "${vipCode}"
        }
      assertion: [ json: { $.code: '0' } ]
    - name: 新建社区活动-配置奖池
      keyWord: 新建社区活动
      bodyEditor:
        json:
          $.prizeConfig: [
            { "type": 1,"prizePoolConfig": [ { "level": 1,"tradeAmount": "50000","prizeAmount": "100" },{ "level": 2,"tradeAmount": "100000","prizeAmount": "200" },{ "level": 3,"tradeAmount": "200000","prizeAmount": "400" } ],"prizeDistributionConfig": [ { "sort": "1","rank": [ 1 ],"prizeRatio": 0.45 },{ "sort": "2","rank": [ 2 ],"prizeRatio": 0.2 },{ "sort": "3","rank": [ 3 ],"prizeRatio": 0.15 },{ "sort": "4","rank": [ 4,5 ],"prizeRatio": 0.05 },{ "sort": "5","rank": [ 6,7,8,9,10 ],"prizeRatio": 0.02 } ] },
            { "type": 2,"prizePoolConfig": [ { "level": 1,"tradeAmount": "60000","prizeAmount": "300" },{ "level": 2,"tradeAmount": "120000","prizeAmount": "600" },{ "level": 3,"tradeAmount": "200000","prizeAmount": "1000" } ],"prizeDistributionConfig": [ { "sort": "1","rank": [ 1 ],"prizeRatio": 0.45 },{ "sort": "2","rank": [ 2 ],"prizeRatio": 0.2 },{ "sort": "3","rank": [ 3 ],"prizeRatio": 0.15 },{ "sort": "4","rank": [ 4,5 ],"prizeRatio": 0.05 },{ "sort": "5","rank": [ 6,7,8,9,10 ],"prizeRatio": 0.02 } ] }
          ]
    - name: 社区活动列表
      host: ${partnersadmin_host}
      url: /partner/root/activity/list
      variables:
        page: 1
        pageSize: 10
        partnerInfo: ${partner_uid}
      headers:
        Token: ${partnersadmin_token}
      method: GET
      assertion: [ json: { $.code: '0' } ]
      extractor:
        - json:
            actId: $.result.items[?(@.shortLink == '${shortLink}')].id
    - name: 社区活动列表-报名中
      untilWait: 60
      keyWord: 社区活动列表
      assertion:
        - json:
            $.result.items[?(@.shortLink == '${shortLink}')].status: [ 2 ]
    - name: 社区活动列表-活动中
      untilWait: 1260
      keyWord: 社区活动列表
      assertion:
        - json:
            $.result.items[?(@.shortLink == '${shortLink}')].status: [ 3 ]