keyWord:
  step:
    - name: 登录partnersadmin
      host: ${partnersadmin_host}
      url: /partner/root/login
      method: POST
      body: |
        {"password":"${__digest(MD5,${partnersadmin_password})}","account":"${partnersadmin_account}"}
      extractor:
        - json:
            partnersadmin_token: $.result.token
          site: TESTSUITE
    - name: 获取BD列表
      host: ${partnersadmin_host}
      url: /partner/root/bdList
      headers:
        Token: ${partnersadmin_token}
      method: GET
      extractor:
        - json:
            bd_uid: $.result[?(@.nickName=='${bd_name}')].uid
    - name: 获取用户信息
      host: ${partnersadmin_host}
      url: /partner/root/getUserInfoByUid/${userId}
      headers:
        Token: ${partnersadmin_token}
      method: GET
      extractor:
        - json:
            nickName: $.result.nickname
    - keyWord: 获取用户信息
      name: 获取用户信息和上级代理uid
      extractor:
        - json:
            nickName: $.result.nickname
            superiorPartnerUid: $.result.parentUid
    - name: 新增合伙人
      host: ${partnersadmin_host}
      url: /partner/root/add
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        {"uid":${userId},"futureRatio":95,"exchangeRatio":95,"nickName":"${nickName}","bdUid":${bd_uid}}
    - name: 佣金发放查询
      host: ${partnersadmin_host}
      url: /partner/root/rebate/statistics/list
      method: GET
      headers:
        Token: ${partnersadmin_token}
      variables:
        showBelow: true
        partnerInfo: ${partnerInfo}
        page: 1
        pageSize: 10
      extractor:
        - json:
            tradeAmount: $.result.items[?(@.symbol=='${symbol}')].tradeAmount
            realFee: $.result.items[?(@.symbol=='${symbol}')].realFee
            fee: $.result.items[?(@.symbol=='${symbol}')].fee
            userRebate: $.result.items[?(@.symbol=='${symbol}')].userRebate
            partnerRebate: $.result.items[?(@.symbol=='${symbol}')].partnerRebate
    - name: 合伙人列表
      host: ${partnersadmin_host}
      url: /partner/root/page
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        {"page":1,"pageSize":10,"uid":"${partner_uid}","registerStart":"","registerEnd":"","pageIndex":1}
      extractor:
        - json:
            totalExchangeRatio: $.result.items[0].exchangeRatio
            totalFutureRatio: $.result.items[0].futureRatio
          site: TESTSUITE
    - name: 变更BD
      host: ${partnersadmin_host}
      url: /partner/root/change_bd
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        {"bdUid":1,"uid":${partner_uid}}
      assertion: [ json: { $.code: '0' } ]
    - name: BD统计
      untilWait: 5
      host: ${partnersadmin_host}
      url: /partner/root/get_bd_team_information
      method: GET
      headers:
        Token: ${partnersadmin_token}
      variables:
        page: 1
        pageSize: 10
        partnerInfo: ${bd_name}
        startTime: ${__PlusDay(yyyy-MM-dd,0,)}T00:00:00.000Z
        endTime: ${__PlusDay(yyyy-MM-dd,0,)}T23:59:59.999Z
        orderType: 4
        orderDirection: DESC
      extractor:
        - json:
            bdTotalPartners: $.result.items[0].totalPartners
            bdTeamSize: $.result.items[0].teamSize
            #新增用户
            bdNewUser: $.result.items[0].newUser
            #总交易额
            bdTradeAmount: $.result.items[0].totalTradeAmount
            #交易人数
            bdTotalTradeUsers: $.result.items[0].totalTradeUsers
            # 平台收益
            bdPlatformRevenue: $.result.items[0].platformRevenue
            # 佣金总计
            bdTotalCommission: $.result.items[0].totalCommission
            # 总手续费
            bdTotalFee: $.result.items[0].totalFee
    - keyWord: BD统计
      name: BD统计-校验新增合伙人
      assertion:
        - json:
            $.result.items[0].teamSize: ${__BeanShell(${bdTeamSize} + 1)}
            $.result.items[0].totalPartners: ${__BeanShell(${bdTotalPartners} + 1)}
            $.result.items[0].totalTradeAmount: ${bdTradeAmount}
            $.result.items[0].newUser: ${__BeanShell(${bdNewUser} + 1)}
    - keyWord: BD统计
      name: BD统计-用户合伙人邀请码注册
      assertion:
        - json:
            $.result.items[0].newUser: ${__BeanShell(${bdNewUser} + 1)}
            $.result.items[0].teamSize: ${__BeanShell(${bdTeamSize} + 1)}
            $.result.items[0].totalTradeAmount: ${bdTradeAmount}
            $.result.items[0].totalTradeUsers: ${bdTotalTradeUsers}
            $.result.items[0].platformRevenue: ${bdPlatformRevenue}
            $.result.items[0].totalCommission: ${bdTotalCommission}
            $.result.items[0].totalFee: ${bdTotalFee}
            $.result.items[0].totalPartners: ${bdTotalPartners}
    - name: BD统计-团队人数不变
      keyWord: BD统计
      assertion:
        - json:
            $.result.items[0].teamSize: ${bdTeamSize}
            $.result.items[0].totalPartners: ${bdTotalPartners}
            $.result.items[0].totalTradeAmount: ${bdTradeAmount}
            $.result.items[0].newUser: ${bdNewUser}
            $.result.items[0].platformRevenue: ${bdPlatformRevenue}
            $.result.items[0].totalCommission: ${bdTotalCommission}
            $.result.items[0].totalFee: ${bdTotalFee}
    - name: BD统计-开仓
      keyWord: BD统计
      assertion:
        - json:
            $.result.items[0].totalTradeAmount: ${__BeanShell(${bdTradeAmount} +${makerTradeAmount})}
            $.result.items[0].totalTradeUsers: ${__BeanShell(${bdTotalTradeUsers} + 1)}
            $.result.items[0].totalFee: ${__BeanShell(${bdTotalFee} + ${openDealFee})}
            $.result.items[0].platformRevenue: ${__BeanShell(${bdPlatformRevenue} + ${openDealFee} * 0.05)}
            $.result.items[0].totalCommission: ${__BeanShell(${bdTotalCommission} + ${openDealFee} * 0.95)}
            $.result.items[0].totalPartners: ${bdTotalPartners}
          assertionType: EIGHTDECIMALPLACES
    - name: BD统计-平仓
      keyWord: BD统计
      assertion:
        - json:
            $.result.items[0].totalTradeAmount: ${__BeanShell(${bdTradeAmount} +${closeQuoteAmount})}
            $.result.items[0].totalTradeUsers: ${__BeanShell(${bdTotalTradeUsers})}
            $.result.items[0].totalFee: ${__BeanShell(${bdTotalFee} + ${closeDealFee})}
            $.result.items[0].platformRevenue: ${__BeanShell(${bdPlatformRevenue} + ${closeDealFee} * 0.05)}
            $.result.items[0].totalCommission: ${__BeanShell(${bdTotalCommission} + ${closeDealFee} * 0.95)}
            $.result.items[0].totalPartners: ${bdTotalPartners}
          assertionType: EIGHTDECIMALPLACES
    - name: 新建社区活动
      host: ${partnersadmin_host}
      url: /partner/root/activity/create
      headers:
        Token: ${partnersadmin_token}
      method: POST
      body: |
        { "uid": ${partner_uid},
          "titleList": [{"languageKey": "en-US","content": "${shortLink}"}],
          "enrollStartTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-8H-10M-60S,zh_CN,)}",
          "enrollEndTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-7H-55M,zh_CN,)}",
          "startTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-7H-54M-59S,zh_CN,)}",
          "endTime": "${__timeShift(yyyy-MM-dd'T'HH:mm:ss'Z',,PT-7H-45M,zh_CN,)}",
          "actType": [{"rankType":1,"tradingVolume":0,"listDisplayVolume":10},{"rankType":2,"tradingVolume":0,"listDisplayVolume":10}],
          "actDetail": [{"languageKey": "en-US","content": "<p>测试</p>"}],
          "futureMinBalance": 1,
          "minJoinUser": 0,
          "shortLink": "${shortLink}",
          "showEntrance": true,
          "entranceDisplay": [{"languageKey": "en-US","content": "test"}],
          "activityEndDisplayInformation": [{"languageKey": "en-US","content": "test"}]
        }
      assertion: [ json: { $.code: '0' } ]
    - name: 社区活动列表
      host: ${partnersadmin_host}
      url: /partner/root/activity/list
      variables:
        page: 1
        pageSize: 10
      headers:
        Token: ${partnersadmin_token}
      method: GET
      assertion: [ json: { $.code: '0' } ]
      extractor:
        - json:
            actId: $.result.items[?(@.shortLink == '${shortLink}')].id
    - name: 社区活动列表-报名中
      untilWait: 10
      keyWord: 社区活动列表
      assertion:
        - json:
            $.result.items[?(@.shortLink == '${shortLink}')].status: [ 2 ]
    - name: 社区活动列表-活动中
      untilWait: 600
      keyWord: 社区活动列表
      assertion:
        - json:
            $.result.items[?(@.shortLink == '${shortLink}')].status: [ 3 ]