name: 催单消息
feature: ${reminder_type}
dataProvider:
  - node_state: asked
    reminder_type: 咨询未下单
    message: 'this is message!'
    text_with_vars: ${message}
beforeClass:
  name: 获取taskID和模板
  step:
    - byName: 获取task_id
    - byName: 获取task模板
testMethod:
  - name: 催单消息
    description: |
      """</br>
      用例描述：</br>
      1、催单消息的内容正确。</br>
      </br>
      测试步骤</br>
      1、修改reminder</br>
      2、发送消息给商家
      3、校验催单信息</br>
      """
    severity: NORMAL
    step:
      - byName: 修改的task内容
        name: 开启与客服会话过滤
        bodyEditor:
          json:
            $.id: ${task_id}
            $.enable: true
            $.shop_id: ${shop_id}
            $.rules[?(@.type=='state_delay')].args.delay: 0
            $.rules[?(@.type=='send_message_by_intent')].args[?(@.intent=='')].replies[0].message: ${message}
            $.rules[?(@.type=='send_message_by_intent')].args[?(@.intent=='')].enable: true
      - name: 发送消息给商家
        url: /robot/answer
        variables:
          version_num: dist
          pin: cnjd${__RandomString(8,zxcvbnmlkjhgfdsaqwertyuiopQWERTYUIOPASDFGHJKLZXCVBNM1234567890,buyer_id)}
          msg_time: ${__time(/1000,msg_time)}
          msgid: ${__RandomString(32,1234567890abcdef,)}
          q: ${__DES3Cipher(在吗？,,)}
          platform: ${platform}
          qianniu_version_num: 8.9.1.500
          service_status: 7
          usr_shut: 0
          spin: cnjd${shopName}
        headers:
          Content-Type: multipart/form-data
        method: GET
        responseType: DEFAULT
        extractor:
          - json:
              qstr: $.answer
            need_decode: true
      - byName: 获取催单消息
        assertion:
          - json:
              $.data.messages[?(@.task_id=='${task_id}')].text_with_vars:
                - ${text_with_vars}