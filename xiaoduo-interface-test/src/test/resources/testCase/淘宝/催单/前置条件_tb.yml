name: 统一前置处理
#所有测试执行前执行
platform: 淘宝,融合版
beforeSuite:
  name: 登录mp后台
  step:
    - name: 获取MP后台地址
      url: /api/auth/mp_switcher
      variables:
        subnick: ${shopName}
      method: GET
      assertion:
        - json:
            $.code: 0
      extractor:
        - json:
            auth_url: $.url
    - name: 进入主页
      host: ""
      url: ${auth_url}
      method: GET
      responseType: DEFAULT
    - name: 获取shop_id
      url: /api/admin/user/logined
      method: GET
      extractor:
        - json:
            shop_id: $.user.shop_id
            shop_category_id: $.default_shop.category_id
          site: TESTSUIT
      assertion: [json: {$.code: 0}]
    - name: 获取子账号
      url: /api/admin/platform/search_client_configs_v3
      variables:
        limit: 20
        skip: 0
        only_supplier: false
      method: GET
      extractor:
        - json:
            seller_name: $.subusers[?(@.auth_status==0)].sub_nick[0]
            child_seller: $.subusers[?(@.auth_status==1)].sub_nick[0]
            child_seller2: $.subusers[?(@.auth_status==1)].sub_nick[1]
            child_seller3: $.subusers[?(@.auth_status==1)].sub_nick[2]
            child_seller4: $.subusers[?(@.auth_status==1)].sub_nick[3]
          site: TESTSUIT
      assertion: [json: {$.code: 0}]
    - name: 催单设置为自己和静默
      url: /api/admin/user/shop_subnick_client_config_edit_v3
      headers:
        Content-Type: multipart/form-data
      untilWait: 15
      method: POST
      form:
        sub_nick: ${seller_name}
        reminder_type: mine,silence
      assertion: [json: {$.code: 0}]
    - name: 设置单个顾客单日最高催单数
      url: /api/admin/reminder/v2/manage/shop/setting
      method: POST
      body: |
        {"user_daily_limit":10000,"no_answer_filter":false,"task_remove_duplicates":false,"no_reception_silence_day":12,"user_list_trigger_enable":false,"basic_advanced":false}
      assertion: [json: {$.code: 0}]
    - name: 拉一下催单消息
      url: /api/client/reminder/v2/client/reminder/messages
      untilWait: 15
      variables:
        shop_id: ${shop_id}
        seller_id: ${seller_name}
        platform: ${platform}
        service_names: reminder
        accept: tb/subscribe_card
      method: GET
      assertion: [json: {$.code: 0}]
    - name: 获取所有催单节点的task_id
      url: /api/admin/reminder/v2/manage/task/list
      variables:
        template_keys: 0
      method: GET
      assertion: [json: {$.code: 0}]
      extractor:
        - json:
            task_list: $.data.tasks[*].id
          size: 100
          options: [DEFAULT_PATH_LEAF_TO_NULL]
    - byName: 删除其他催单任务
    - byName: 获取所有的测试任务
    - byName: 删除所有测试催单任务
async:
  name: 心跳检测表示客服在线
  step:
    - byName: 子账号发送心跳检测
      name: 主账号发送心跳检测
      variables:
        spin: cntaobao${seller_name}
        sign: ${__HmacMD5(spin=cntaobao${seller_name})}
    - name: 子账号发送心跳检测
      host: ${api_host}
      url: /log/hb
      variables:
        spin: cntaobao${child_seller}
        platid: tb
        hangup: false
        platstatus: 1
        shopid: ${shop_id}
        version: 4.33.0
        sign: ${__HmacMD5(spin=cntaobao${child_seller})}
      method: GET
      assertion: [json: {$.code: 0}]
    - byName: 子账号发送心跳检测
      name: 子账号3发送心跳检测
      variables:
        spin: cntaobao${child_seller3}
        sign: ${__HmacMD5(spin=cntaobao${child_seller3})}