name: 付款单数
dataProvider:
  - order_state: paid
    order_state_name: 已付款
beforeClass:
  name: 设置分群
  severity: CRITICAL
  step:
    - byName: 新建顾客分群
      name: 新建数顾客分群-设置单数2-4个
      bodyEditor:
        json:
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.type: paid_order_num
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.rule.type: paid_order_num
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.rule.time: 2592000
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.rule.order_min_num: 2
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.rule.order_max_num: 4
    - byName: 查看分群列表-获取新分群ID
    - byName: 校验初始分群人数为0
      name: 获取初始化后的分群人数
      untilWait: 30
      assertion:
        - json:
            $.data.results[?(@.id=='${group_id}')].status: [""]
      extractor:
        - json:
            customer_count: $.data.results[?(@.id=='${group_id}')].customer_count
testMethod:
  - name: 付款单数分群-只有一个订单不会流入
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息-随机顾客
      - byName: 获取初始化后的分群人数
        name: 校验分群人数未增加
        assertion:
          - json:
              $.data.results[?(@.id=='${group_id}')].customer_count: ["${customer_count}"]
  - name: 付款单数分群-有2个订单流入
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息
      - byName: 获取初始化后的分群人数
        name: 校验分群人数增加
        assertion:
          - json:
              $.data.results[?(@.id=='${group_id}')].customer_count: ["${__BeanShell(${customer_count}+1,)}"]
  - name: 付款单数分群-有3个订单人数不变
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息
      - byName: 校验分群人数未增加
  - name: 付款单数分群-有4个订单人数不变
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息
      - byName: 校验分群人数未增加
  - name: 付款单数分群-有5个订单流出
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息
      - byName: 获取初始化后的分群人数
        name: 校验分群人数减少
        assertion:
          - json:
              $.data.results[?(@.id=='${group_id}')].customer_count: ["${__BeanShell(${customer_count}-1,)}"]
afterClass:
  name: 删除智能分群
  severity: CRITICAL
  step:
    - byName: 删除智能分群