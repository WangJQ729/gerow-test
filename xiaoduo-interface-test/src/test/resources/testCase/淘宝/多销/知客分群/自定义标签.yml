name: 自定义标签
dataProvider:
  - order_state: paid
    order_state_name: 已付款
beforeClass:
  name: 设置分群
  step:
    - name: 新建顾客标签
      url: /api/zhike/tag/create
      method: POST
      body: |
        {"name":"${__RandomString(8,zxcvbnmlkjhgfdsaqwertyuiopQWERTYUIOPASDFGHJKLZXCVBNM1234567890,tag_name)}"}
      assertion: [json: {$.code: 0}]
    - name: 获取时效标签列表
      url: /api/zhike/tag/list
      method: GET
      assertion: [json: {$.code: 0}]
      extractor:
        - json:
            tag_id: $.data.results[?(@.name=='${tag_name}')].id
    - byName: 新建顾客分群
      name: 新建数顾客分群-自定义标签
      bodyEditor:
        json:
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.type: zhike_tag
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.rule.type: zhike_tag
          $.customer_group.cond.select_cond.child_conds[0].child_conds[0].cond.rule.values: ["${tag_id}"]
    - byName: 查看分群列表-获取新分群ID
    - byName: 获取初始化后的客群人数
testMethod:
  - name: 顾客没有标签不流入
    step:
      - byName: 通过pulsar推送订单消息-随机顾客
      - name: 获取顾客列表
        url: /api/zhike/customer/search_list
        untilWait: 5
        variables:
          skip: 0
          limit: 20
          shop_id: ${shop_id}
          begin_time: ${__StartOfDay()}
          end_time: ${__EndOfDay()}
          is_complaint_group: false
        method: GET
        assertion: [json: {$.code: 0}]
        extractor:
          - json:
              customer_body: $.data.customers[?(@.attrs.nick=='${buyer_id}')]
      - byName: 校验客群人数未增加
  - name: 顾客被添加标签后-标签分群人数增加
    step:
      - name: 给买家添加标签
        url: /api/zhike/customer/update
        method: POST
        body: |
          {"customer": ${customer_body}}
        bodyEditor:
          json:
            $.customer.tags: [{"id":1,"name": "${tag_name}"}]
            $.customer.tags[0].id: ${__BeanShell(${tag_id}l)}
        assertion: [json: {$.code: 0}]
      - byName: 校验客群人数增加
afterClass:
  name: 删除智能分群
  step:
    - byName: 删除智能分群
    - name: 顾客标签
      url: /api/zhike/tag/delete
      variables:
        id: ${tag_id}
      method: POST
      assertion: [json: {$.code: 0}]