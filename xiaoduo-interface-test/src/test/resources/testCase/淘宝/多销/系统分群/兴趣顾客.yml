name: 兴趣顾客
dataProvider:
  - group_name: 兴趣顾客
    order_state: created
    new_order_state: paid
    results_level: results
beforeClass:
  name: 设置分群
  severity: CRITICAL
  step:
    - byName: 查看分群列表-获取新分群ID
      name: 获取系统分群顾客人数
      sleep: 2
      variables:
        is_deleted: false
        shop_id: ${shop_id}
        is_system: true
      extractor:
        - json:
            group_id: $.data.${results_level}[?(@.name=='${group_name}')].id
            customer_count: $.data.${results_level}[?(@.id=='${group_id}')].customer_count
testMethod:
  - name: 顾客咨询后流入
    severity: CRITICAL
    step:
      - byName: 发送消息给商家-固定问题
      - byName: 获取系统分群顾客人数
        name: 校验系统分群人数增加
        assertion:
          - json:
              $.data.${results_level}[?(@.id=='${group_id}')].customer_count: ["${__BeanShell(${customer_count}+1,)}"]
  - name: 顾客咨询后有下单-不流出
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息
      - byName: 获取系统分群顾客人数
        name: 校验系统分群人数未增加
        assertion:
          - json:
              $.data.${results_level}[?(@.id=='${group_id}')].customer_count: ["${customer_count}"]
  - name: 顾客咨询后有下单且已付款-流出
    severity: CRITICAL
    step:
      - byName: 通过pulsar推送订单消息-状态变更
      - byName: 获取系统分群顾客人数
        name: 校验系统分群人数减少
        assertion:
          - json:
              $.data.${results_level}[?(@.id=='${group_id}')].customer_count: ["${__BeanShell(${customer_count}-1,)}"]