name: 复购营销
dataProvider:
  - last_time: ${__BeanShell(${__time(/1000,)}-24*60*60,)}
    buyer_id: ${__RandomName(buyer_name)}
beforeClass:
  name: zhike_ordertrace表中插入测试数据（昨日有下单的用户）
  step:
    - name: zhike_ordertrace表中插入测试数据
      host: ${test_tools_new}
      url: /api/v1/mongoInsert
      method: POST
      body: |
        {
            "service":"mongo-zhike-pri",
            "port":"27017",
            "platform":"${test_tools_new}",
            "db":"zhike",
            "data": {
                    	"shop_id" : "${shop_id}",
                    	"nick" : "cntaobao${buyer_id}",
                    	"platform" : "tb",
                    	"update_ts" : ${last_time},
                    	"create_ts" : ${last_time},
                    	"order" : {
                    		"tid" : "${__RandomOrderId(order_id)}",
                    		"payment" : 20,
                    		"goods" : [
                    			"604423906694"
                    		],
                    		"items" : [
                    			{
                    				"item_id" : "604423906694",
                    				"item_name" : "二手铅笔",
                    				"count" : 1,
                    				"pic_path" : "https://img.alicdn.com/bao/uploaded/i3/1740721126/O1CN01PUtjEb1KBkX6UpzOm_!!1740721126.jpg"
                    			}
                    		]
                    	},
                    	"traces" : {
                    		"paid" : ${last_time}
                    	},
                    	"addr_list" : [
                    		{
                    			"addr" : "桂溪街道天府软件园A5-8",
                    			"city" : "成都市",
                    			"district" : "武侯区",
                    			"state" : "四川省",
                    			"country" : "",
                    			"town" : "桂溪街道",
                    			"zip" : "000000",
                    			"mobile" : "17721883949",
                    			"receiver_name" : ""
                    		}
                    	],
                    	"phone" : "17721883949"
                    },
            "col":"zhike_ordertrace"
        }
      assertion:
        - json:
            $.code: 0
            $.message: success
testMethod:
  - name: 新建一个复购营销计划
    dataProvider:
      - message: 纯文字催单消息
        text_with_vars: 纯文字催单消息
      - message: "营销内容带子账号变量"
        text_with_vars: ${seller_name}
      - message: "营销内容带分行变量"
        text_with_vars: "1{↓1秒后分行发送↓}2"
      - message: "营销内容带表情"
        text_with_vars: "/:^_^/:^$^"
    description: |
      """</br>
      用例描述：</br>
      1、营销话术消息内容正确。</br>
      2、客池中的顾客均能收到推送消息。</br>
      </br>
      测试步骤</br>
      1、创建客池复购营销</br>
      2、获取消息、校验消息内容</br>
      """
    severity: NORMAL
    step:
      - name: 上传一张图片
        host: ${seller_host}
        url: /api/fishpond/image/upload
        method: POST
        headers:
          Content-Type: multipart/form-data
        file:
          file: "src/test/resources/upload.jpg"
        assertion:
          - json:
              $.code: 0
        extractor:
          - json:
              image_url: $.data.url
      - name: 选取一个指定客服
        host: ${seller_host}
        url: /api/fishpond/xd_sub_user/groups/selection/new
        method: POST
        body: |
          {"group_id_list":"","sub_user_name_list":"${seller_name}"}
        assertion:
          - json:
              $.message: 成功
              $.code: 0
        extractor:
          - json:
              seller_group_id: $.id
      - name: 创建复购营销计划
        host: ${seller_host}
        url: /api/fishpond/task_plan/create_re_plan
        method: POST
        body: |
          {
              "name":"${__time(yyyyMMdd_HHmmss,taskName)}",
              "is_open_sms":false,
              "last_seller_first":true,
              "type":"repurchase",
              "message":{
                  "text":"${text_with_vars}",
                  "images":[{"url": "${image_url}"}]
              },
              "seller_group_id":"${seller_group_id}",
              "crowd_oriented":{
                  "goods_ids":[],
                  "last_paid_day":1
              },
              "send_time":[
                  {
                      "from":${__SecondOfDay(60)},
                      "to":${__SecondOfDay(180)}
                  }
              ]
          }
        assertion: [json: {$.code: 0}]
      - byName: 获取营销任务ID
      - byName: 获取多销消息
        variables:
          seller_id: ${seller_name}
