name: 统一营销话术
beforeClass:
  name: 流入一个客人并修改离开鱼池时间
  step:
    - byName: 发送消息给商家-POST-固定问题
    - name: 修改离开鱼池时间
      host: ${test_tools}
      url: /api/v1/tools/redisZSet
      headers:
        Authorization: auth ${token}
      method: POST
      untilWait: 30
      body: |
        {
            "zset_key":"fp:{tb:${shop_id}}",
            "member":"${buyer_id}",
            "score": ${__EndOfDay()}
        }
      assertion: [json: {$.code: 0}]
testMethod:
  - name: 消息内容校验-${message}
    dataProvider:
      - message: 纯文字催单消息
        text_with_vars: 纯文字催单消息
      - message: "{{子账号名称}}"
        text_with_vars: ${seller_name}
      - message: "1{↓1秒后分行发送↓}2"
        text_with_vars: "1{↓1秒后分行发送↓}2"
    description: |
      """</br>
      用例描述：</br>
      1、营销话术消息内容正确。</br>
      </br>
      测试步骤</br>
      1、创建客池精准营销</br>
      2、获取消息、校验消息内容</br>
      """
    severity: NORMAL
    step:
      - name: 获取边缘客群任务id
        host: ${seller_host}
        url: /api/fishpond/task_plan
        method: GET
        assertion: [json: {$.code: 0}]
        extractor:
          - json:
              task_ids: $.data.task_plans[*].id
            size: 100
            options: [DEFAULT_PATH_LEAF_TO_NULL]
      - name: 停止边缘客群任务
        iter:
          task_id: ${task_ids}
        host: ${seller_host}
        url: /api/fishpond/task_plan/stop
        method: POST
        body: |
          {"id":"${task_id}"}
        assertion: [json: {$.code: 0}]
      - name: 修改边缘客群任务
        host: ${seller_host}
        url: /api/fishpond/task_plan
        method: POST
        body: |
          {
              "name":"${__time(yyyyMMdd_HHmmss,taskName)}",
              "last_seller_first":true,
              "send_range":1,
              "send_groups":[],
              "sellers":[
                "${seller_name}"
              ],
              "send_time":[
                  {
                    "from":${__SecondOfDay(60)},
                    "to":${__SecondOfDay(180)}
                  }
              ],
              "message":{
                  "text":"${message}",
                  "images":[
                  ]
              },
              "start_date":"",
              "end_date":"long-term",
              "need_diff_messages":false,
              "diff_messages":[]
          }
        assertion: [json: {$.code: 0}]
      - byName: 获取多销消息